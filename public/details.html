<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GlowGive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-semibold" href="#">GlowGive</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/search.html">Search</a></li>
            </ul>
        </div>
    </div>
</header>

<!-- Detail -->
<section class="bg-body-tertiary border-bottom py-4">
    <div class="container">
        <a href="javascript:history.back()" class="btn btn-link px-0"><i class="bi bi-arrow-left"></i> Back</a>
        <div class="row g-4 align-items-center mt-1">
            <div class="col-lg-7">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <span class="badge rounded-pill text-bg-primary" id="badgeCategory">Category</span>
                    <span class="badge rounded-pill text-bg-dark" id="badgeOrg">Organisation</span>
                    <span class="badge rounded-pill text-bg-warning d-none" id="badgePast">Past</span>
                    <span class="badge rounded-pill text-bg-secondary d-none" id="badgeSuspended">Suspended</span>
                </div>
                <h1 class="h2 mb-2" id="evName">Event name</h1>
                <p class="text-secondary mb-0" id="evShort">Short description...</p>
                <div class="d-flex flex-wrap gap-3 mt-3 small text-body-secondary">
                    <span><i class="bi bi-geo-alt"></i> <span id="evLocation">—</span></span>
                    <span><i class="bi bi-calendar-event"></i> <span id="evDates">—</span></span>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="ratio ratio-16x9 rounded-3 shadow" id="cover" style="background: url('/placeholder.png') center/cover no-repeat;"></div>
            </div>
        </div>
    </div>
</section>

<main class="py-4">
    <div class="container">
        <div id="statusBar" class="alert alert-info d-none" role="alert"></div>

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- About / Full description -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h5 mb-3">About this event</h2>
                        <p id="evFull" class="mb-0 text-body-secondary">—</p>
                    </div>
                </div>

                <!-- Organisation info -->
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <h2 class="h6 mb-3">Hosted by</h2>
                        <div class="d-flex flex-column gap-1">
                            <div class="fw-semibold" id="orgName">—</div>
                            <div class="text-body-secondary small" id="orgMission">—</div>
                            <div class="small mt-2 d-flex flex-wrap gap-3">
                                <span><i class="bi bi-envelope"></i> <a id="orgEmail" href="#">—</a></span>
                                <span><i class="bi bi-globe"></i> <a id="orgSite" href="#" target="_blank" rel="noopener">—</a></span>
                                <span class="d-none" id="orgPhoneWrap"><i class="bi bi-telephone"></i> <span id="orgPhone"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Funding / Progress -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h2 class="h6 mb-3">Support progress</h2>
                        <div class="d-flex justify-content-between small">
                            <span>Goal</span>
                            <strong id="goal">—</strong>
                        </div>
                        <div class="d-flex justify-content-between small mt-1">
                            <span>Raised</span>
                            <strong id="raised">—</strong>
                        </div>
                        <div class="progress mt-3" style="height: 10px;">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="text-end small mt-1"><span id="percent">—</span></div>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-primary" id="btnRegister" onclick="alert('This feature is currently under construction.')"><i class="bi bi-heart"></i> Register</button>
                        </div>
                    </div>
                </div>

                <!-- Quick facts -->
                <div class="card shadow-sm mt-3">
                    <div class="card-body small">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Registrations</span>
                            <strong id="regCount">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Total tickets</span>
                            <strong id="totalQty">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<footer class="border-top py-4 mt-5 small text-center text-body-secondary">
    <div class="container">© 2025 GlowGive</div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
  const $status = document.getElementById('statusBar');

  function setStatus(msg, type = 'info') {
    if (!msg) {
      $status.classList.add('d-none');
      return;
    }
    $status.className = `alert alert-${type}`;
    $status.textContent = msg;
    $status.classList.remove('d-none');
  }

  async function loadDetails() {
    try {
      setStatus('Loading…');
      const p = new URLSearchParams(location.search);
      const id = p.get('id');
      if (!id) {
        setStatus('Missing event id', 'danger');
        return;
      }

      const res = await fetch(`http://localhost:3060/api/events/${id}`);
      const ev = await res.json();

      // Badges
      document.getElementById('badgeCategory').textContent = ev.category_name;
      document.getElementById('badgeOrg').textContent = ev.organisation_name;
      if (ev.is_suspended)  {
        document.getElementById('badgeSuspended').classList.remove('d-none');
      }
      const isPast = new Date(ev.end_datetime) < new Date();
      if (isPast) {
        document.getElementById('badgePast').classList.remove('d-none');
      }

      // detail texts
      document.getElementById('evName').textContent = ev.name;
      document.getElementById('evShort').textContent = ev.short_description || '';
      document.getElementById('evLocation').textContent = [ev.venue_name, ev.address_line1, ev.city, ev.state_region, ev.postcode].filter(Boolean).join(' · ');
      document.getElementById('evDates').textContent = `${new Date(ev.start_datetime).toLocaleString()} — ${new Date(ev.end_datetime).toLocaleString()}`;

      // Cover
      const cover =  document.getElementById('cover');
      const img = ev.image_url || '/placeholder.png';
      cover.style.backgroundImage = `url('${img}')`;

      // About
      document.getElementById('evFull').textContent = ev.full_description || '—';

      // Org box
      document.getElementById('orgName').textContent = ev.organisation_name || '—';
      document.getElementById('orgMission').textContent = ev.mission_text || '';
      if (ev.contact_email){
        const a = document.getElementById('orgEmail');
        a.href = `mailto:${ev.contact_email}`;
        a.textContent = ev.contact_email;
      }
      if (ev.website_url){
        const a = document.getElementById('orgSite');
        a.href = ev.website_url;
        a.textContent = ev.website_url.replace(/^https?:\/\//,'');
      }
      if (ev.contact_phone){
        document.getElementById('orgPhone').textContent = ev.contact_phone;
        document.getElementById('orgPhoneWrap').classList.remove('d-none')
      }

      // Progress
      const goal = Number(ev.progress?.goal_amount || ev.goal_amount || 0);
      const raised = Number(ev.progress?.raised_amount || 0);
      const percent = (ev.progress?.percent == null) ? null : Number(ev.progress.percent);
      document.getElementById('goal').textContent = goal > 0 ? '$' + goal : 'No goal';
      document.getElementById('raised').textContent = '$' + raised;
      const bar = document.getElementById('progressBar');
      if (percent == null) {
        bar.style.width = '0%';
        bar.classList.add('bg-secondary');
        document.getElementById('percent').textContent = '—';
      } else {
        bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        document.getElementById('percent').textContent = `${percent}%`;
      }

      // Facts
      document.getElementById('regCount').textContent = ev.registration_stats?.reg_count;
      document.getElementById('totalQty').textContent = ev.registration_stats?.total_qty;

      setStatus(null);
    } catch (err) {
      console.error(err);
      setStatus('Failed to load details. Check API server.', 'danger');
    }
  }

  loadDetails();
</script>
</body>
</html>
